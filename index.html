<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OLM : Votre Jumeau Numérique de Compétences</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --c-background: #f9f9fb;
      --c-text-primary: #1d1d1f;
      --c-text-secondary: #515154;
      --c-surface: #ffffff;
      --c-border: #ebebed;
      --c-primary: #007aff;
      --c-primary-hover: #0071e3;
      --c-primary-light: #e5f2ff;
      --c-success: #34c759;
      --c-success-light: #eaf8ee;
    }
    html { scroll-behavior: smooth; }
    body {
      background-color: var(--c-background);
      color: var(--c-text-primary);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    :focus-visible { outline: 2px solid var(--c-primary); outline-offset: 2px; border-radius: 8px; }
    .card {
      background-color: var(--c-surface);
      border: 1px solid var(--c-border);
      border-radius: 1.25rem;
      box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px 0 rgb(0 0 0 / 0.07); }
    .fade-in { animation: fadeIn 0.7s cubic-bezier(0.33, 1, 0.68, 1) forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .lang-btn.active { font-weight: 600; color: var(--c-primary); background-color: var(--c-primary-light); }
    .progress-bar-bg { background-color: #eff0f2; }
    .progress-bar-fg { background-color: var(--c-primary); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    .progress-bar-gain { background-color: var(--c-success); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    .modal-backdrop { background-color: rgba(0,0,0,0.4); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="text-base">

  <div class="fixed top-4 right-4 z-50">
    <div class="flex items-center gap-1 text-sm font-medium text-slate-600 bg-white/80 backdrop-blur-md p-1 rounded-full border border-slate-200 shadow-sm">
        <button id="lang-fr" class="lang-btn px-3 py-1 rounded-full">FR</button>
        <button id="lang-en" class="lang-btn px-3 py-1 rounded-full">EN</button>
    </div>
  </div>

  <header class="max-w-7xl mx-auto px-6 py-20 md:py-28 text-center">
    <h1 class="text-4xl md:text-6xl font-bold tracking-tight text-slate-900" data-translate-key="title"></h1>
    <p class="mt-4 text-lg md:text-xl max-w-3xl mx-auto text-slate-600" data-translate-key="subtitle"></p>
  </header>

  <main class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <section class="lg:col-span-3" aria-labelledby="llm-connect-title">
      <div class="text-center">
        <h2 id="llm-connect-title" class="text-2xl font-bold text-slate-800" data-translate-key="connect_agent_title"></h2>
        <p class="mt-2 text-slate-600 max-w-2xl mx-auto" data-translate-key="connect_agent_subtitle"></p>
      </div>
      <nav aria-label="Fournisseurs LLM" class="mt-8">
        <div id="llmButtons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5"></div>
      </nav>
    </section>

    <section class="lg:col-span-2 card" aria-labelledby="profil-title">
      <div class="p-6 border-b border-slate-200/80 flex justify-between items-start">
        <div>
            <h3 id="profil-title" class="text-lg font-semibold flex items-center gap-3 text-slate-800">
                <svg class="w-6 h-6 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Z"/><path d="M12 17.5a7.5 7.5 0 0 1 7.5-7.5"/><path d="M12 17.5a7.5 7.5 0 0 0-7.5-7.5"/></svg>
                <span id="profileTitle" data-translate-key="profile_title_empty"></span>
            </h3>
            <span id="providerBadge" class="mt-2 hidden items-center gap-2 text-xs pl-2 pr-3 py-1 rounded-full bg-slate-100 text-slate-700 font-medium"></span>
        </div>
        <div id="objectiveWidget" class="hidden text-right">
            <p class="text-xs text-slate-500" data-translate-key="objective_widget_title"></p>
            <p id="objectiveText" class="text-sm font-semibold text-blue-600"></p>
        </div>
      </div>
      <div class="p-6">
        <div id="radar" class="w-full h-72 flex items-center justify-center text-sm text-slate-500" data-translate-key="radar_placeholder"></div>
      </div>
    </section>

    <section class="card" aria-labelledby="console-title">
      <div class="p-6 border-b border-slate-200/80"><h3 id="console-title" class="text-lg font-semibold flex items-center gap-3 text-slate-800">
        <svg class="w-6 h-6 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
        <span data-translate-key="console_title"></span></h3></div>
      <div class="p-6">
        <div id="console" class="bg-slate-900 text-slate-300 text-xs rounded-xl p-4 h-96 overflow-auto font-mono selection:bg-blue-500/30" aria-live="polite"></div>
        <div class="mt-4 flex gap-2">
          <button id="resetBtn" class="w-full px-4 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-50 text-slate-700 text-sm font-semibold transition-colors" data-translate-key="reset_btn"></button>
        </div>
      </div>
    </section>
    
    <section id="aiInsightSection" class="lg:col-span-3 hidden" aria-labelledby="ai-insight-title">
         <div class="border border-blue-200 bg-blue-50/50 rounded-2xl p-6">
            <h3 id="ai-insight-title" class="text-lg font-semibold text-blue-800 flex items-center gap-3">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                <span data-translate-key="ai_insight_title"></span>
            </h3>
            <p id="aiInsightText" class="mt-3 text-sm text-blue-900/80"></p>
         </div>
    </section>

    <section class="lg:col-span-3 py-4" aria-labelledby="reco-title">
      <h2 id="reco-title" class="text-2xl font-bold text-slate-800"><span data-translate-key="challenges_title"></span> <span id="recoProvider" class="text-slate-500 font-normal text-xl"></span></h2>
      <p id="recoHint" class="mt-2 text-slate-600" data-translate-key="challenges_placeholder"></p>
      <div id="recoNotice" class="hidden mt-4 rounded-xl border border-green-200 bg-green-50 text-green-800 text-sm px-4 py-3" aria-live="polite"></div>

      <div id="recoSkeletons" class="mt-6 grid md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
        <div class="h-48 rounded-2xl bg-slate-200 animate-pulse"></div>
        <div class="h-48 rounded-2xl bg-slate-200 animate-pulse"></div>
        <div class="h-48 rounded-2xl bg-slate-200 animate-pulse lg:block hidden"></div>
      </div>

      <div id="recoGrid" class="mt-6 grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <section class="lg:col-span-3 py-4" aria-labelledby="gains-title">
      <h2 id="gains-title" class="text-2xl font-bold text-slate-800" data-translate-key="progress_title"></h2>
      <p id="gainsHint" class="mt-2 text-slate-600" data-translate-key="progress_placeholder"></p>
      <div id="skillProgress" class="mt-6 grid md:grid-cols-2 gap-x-8 gap-y-5"></div>
    </section>

    <section id="certSection" class="lg:col-span-3 py-4" aria-labelledby="cert-title">
        <h2 id="cert-title" class="text-2xl font-bold text-slate-800" data-translate-key="certifications_title"></h2>
        <p id="certHint" class="mt-2 text-slate-600" data-translate-key="certifications_placeholder"></p>
        <div id="certGrid" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>
  </main>

  <section class="max-w-7xl mx-auto px-6 py-20">
    <div class="grid md:grid-cols-3 gap-6">
        <article class="card p-6">
            <h3 class="text-lg font-semibold flex items-center gap-3" data-translate-key="what_is_olm_title"></h3>
            <p class="mt-2 text-sm text-slate-600" data-translate-key="what_is_olm_p"></p>
        </article>
        <article class="card p-6">
            <h3 class="text-lg font-semibold flex items-center gap-3" data-translate-key="why_mcp_title"></h3>
            <p class="mt-2 text-sm text-slate-600" data-translate-key="why_mcp_p"></p>
        </article>
        <article class="card p-6">
            <h3 class="text-lg font-semibold flex items-center gap-3" data-translate-key="design_fiction_title"></h3>
            <p class="mt-2 text-sm text-slate-600" data-translate-key="design_fiction_p"></p>
        </article>
    </div>
  </section>

  <div id="modal" class="hidden fixed inset-0 z-50 items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="fixed inset-0 modal-backdrop" data-close></div>
    <div class="relative bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl max-w-2xl w-full border border-white/50">
      <div class="p-8">
        <h2 id="modalTitle" class="text-xl font-semibold text-slate-800 flex items-center gap-3"></h2>
        <p class="mt-1 text-slate-600" data-translate-key="modal_subtitle"></p>

        <div class="mt-6 grid md:grid-cols-2 gap-6">
          <fieldset class="border border-slate-200/80 rounded-xl p-4 bg-white/50">
            <legend class="px-2 text-sm font-semibold text-slate-700" data-translate-key="modal_data_title"></legend>
            <div id="consents" class="mt-2 space-y-3"></div>
          </fieldset>

          <fieldset class="border border-slate-200/80 rounded-xl p-4 flex flex-col bg-white/50">
            <legend class="px-2 text-sm font-semibold text-slate-700" data-translate-key="modal_objective_title"></legend>
            <div class="flex-1">
              <label for="contextSelect" class="sr-only" data-translate-key="modal_objective_select_sr"></label>
              <select id="contextSelect" class="mt-2 w-full border border-slate-300 rounded-lg px-3 py-2 text-base focus:border-blue-500 focus:ring-blue-500"></select>
              <p class="mt-2 text-xs text-slate-500" data-translate-key="modal_objective_p"></p>
            </div>
            <button id="addContextBtn" type="button" class="mt-3 text-sm font-semibold text-blue-600 hover:text-blue-800 transition-colors self-start" data-translate-key="modal_add_context_btn"></button>
          </fieldset>
        </div>

        <div class="mt-8 flex items-center justify-end gap-3">
          <button type="button" class="px-5 py-2.5 rounded-xl bg-white/80 border border-slate-300 hover:bg-white text-slate-800 font-semibold" data-close data-translate-key="modal_cancel_btn"></button>
          <button id="authorizeBtn" class="px-5 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold" data-translate-key="modal_authorize_btn"></button>
        </div>
      </div>
    </div>
  </div>

  <div id="certModal" class="hidden fixed inset-0 z-50 items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="certModalTitle">
        <div class="fixed inset-0 modal-backdrop" data-cert-close></div>
        <div class="relative bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl max-w-lg w-full border border-white/50">
            <div class="p-8">
                <h2 id="certModalTitle" class="text-lg font-semibold text-slate-800"></h2>
                <p id="certModalSubtitle" class="mt-1 text-slate-500"></p>

                <div class="mt-4 inline-flex items-center gap-2 rounded-full bg-blue-100 text-blue-800 px-3 py-1 text-xs font-semibold">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <span data-translate-key="cert_modal_recognized"></span>
                </div>

                <p id="certModalRationale" class="mt-4 text-slate-600"></p>

                <div id="certSyllabusContainer" class="mt-4 hidden border-t border-slate-200 pt-4">
                    <h4 class="font-semibold text-slate-700" data-translate-key="cert_modal_syllabus_title"></h4>
                    <ul id="certSyllabusList" class="mt-2 text-slate-600 list-disc list-inside space-y-1"></ul>
                </div>

                <div class="mt-6 flex flex-col sm:flex-row-reverse gap-3">
                    <button id="addCertToAgentBtn" class="w-full px-4 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-semibold"></button>
                    <button id="viewSyllabusBtn" class="w-full px-4 py-2.5 rounded-xl bg-white/80 border border-slate-300 hover:bg-white text-slate-800 font-semibold"></button>
                </div>
            </div>
        </div>
    </div>


  <footer class="border-t border-slate-200/80 mt-20">
    <div class="max-w-7xl mx-auto px-6 py-8 text-sm text-slate-500 text-center" data-translate-key="footer">
    </div>
  </footer>

  <script>
    const translations = {
        fr: {
            title: "Maîtrisez votre avenir professionnel.",
            subtitle: "L'Open Learner Model est votre jumeau numérique de compétences. Connectez-le à une IA pour générer un parcours de carrière sur-mesure, basé sur votre profil unique. <br><br> <div class='text-sm italic'>(Dans cette démo, vous incarnez John Doe, un plombier en recherche d'emploi qui souhaite monter en compétences. Aucune donnée réelle n'est transmise, c'est un design fiction. Ce prototype vous ai proposé par Arnaud Guiovanna.)</div>",
            connect_agent_title: "Choisissez votre Agent IA",
            connect_agent_subtitle: "Sélectionnez un agent pour analyser votre profil et construire votre plan de progression.",
            profile_title_empty: "Profil OLM",
            profile_title_user: "Profil OLM de John Doe",
            connected_to: "Connecté à",
            objective_widget_title: "Objectif Actuel",
            radar_placeholder: "Connectez un agent pour visualiser le profil.",
            console_title: "Console d'Activité",
            console_placeholder: "En attente de connexion...",
            reset_btn: "Réinitialiser",
            analyze_with: "Analyser avec {provider}",
            ai_insight_title: "Synthèse de l'Agent",
            challenges_title: "Vos Prochains Défis",
            challenges_by: "— par {provider}",
            challenges_placeholder: "Connectez un agent pour découvrir vos défis personnalisés.",
            reco_notice_success: "✅ Parcours généré avec succès. La progression ci-dessous simule votre gain potentiel.",
            progress_title: "Suivi de Progression",
            progress_placeholder: "L'évolution de vos compétences apparaîtra ici.",
            certifications_title: "Passeports de Certification",
            certifications_placeholder: "Connectez un agent pour identifier des certifications alignées sur votre profil.",
            what_is_olm_title: "🧠 Qu’est-ce qu’un OLM ?",
            what_is_olm_p: "L'<strong>Open Learner Model</strong> est votre profil de compétences dynamique et portable. Il vous appartient, vous le contrôlez, et il fonctionne partout.",
            why_mcp_title: "🔗 Le standard MCP",
            why_mcp_p: "Le <strong>Model Context Protocol (MCP)</strong> est le langage universel qui permet à votre OLM de communiquer de façon sécurisée et standardisée avec n'importe quelle IA.",
            design_fiction_title: "💡 Une Vision du Futur",
            design_fiction_p: "Cette démo illustre un futur où chaque apprenant possède et contrôle ses données d'apprentissage, ouvrant la voie à une reconnaissance universelle des compétences.",
            modal_title: "Autoriser la connexion",
            modal_subtitle: "Partagez les données de votre OLM et définissez un objectif pour l'analyse.",
            modal_data_title: "Données à partager",
            modal_objective_title: "Objectif",
            modal_objective_select_sr: "Sélectionnez un objectif",
            modal_objective_p: "L'agent adaptera ses recommandations à cet objectif.",
            modal_add_context_btn: "+ Ajouter un objectif",
            modal_cancel_btn: "Annuler",
            modal_authorize_btn: "Autoriser & Lancer",
            footer: "Une démonstration interactive par Arnaud Guiovanna • 2025",
            log_connecting: "Connexion sécurisée à l'agent IA...",
            log_connection_request: "OLM ➜ Demande de connexion à {provider}",
            log_handshake_ok: "Handshake MCP 1.0 : OK",
            log_consent: "Consentement ➜ Données partagées : {granted}",
            log_objective: "🎯 Objectif transmis : Améliorer les compétences pour \"{context}\".",
            log_analysis: "Analyse OLM ➜ {count} optimisations potentielles identifiées.",
            log_skill_gain: "✔ Gain de compétence : {skill} (+{delta}) | source: {why}",
            log_recos_generated: "✔ Recommandations générées, prêtes à être explorées.",
            log_challenge_complete: "✔ Défi relevé : \"{title}\" (+{delta} {skill})",
            log_new_skill: "✨ Nouvelle compétence ajoutée au profil : \"{skill}\"",
            reco_card_skill: "Compétence",
            reco_card_duration: "Durée",
            reco_card_completed: "Terminé",
            reco_card_potential_gain: "+{delta} pts",
            reco_card_take_challenge: "Relever le défi",
            progress_bar_gain_text: "{initial} ➜ {final} (+{gain})",
            add_context_prompt: "Entrez le nom de votre nouvel objectif :",
            reco_notice_update: "✅ Compétence \"{skill}\" mise à jour dans votre profil.",
            cert_modal_title: "Certification : {title}",
            cert_modal_subtitle: "Proposée par votre agent {agent}",
            cert_modal_recognized: "Reconnu par le Ministère du Travail",
            cert_modal_add_btn: "Ajouter à mon agent",
            cert_modal_syllabus_btn: "Voir le programme",
            cert_modal_syllabus_btn_hide: "Masquer le programme",
            cert_modal_syllabus_title: "Programme de la certification",
            cert_added_notice: "✅ Le parcours de certification a été ajouté à votre agent {agent}."
        },
        en: {
            title: "Master your professional future.",
            subtitle: "The Open Learner Model is your digital skill twin. Connect it to an AI to generate a tailor-made career path based on your unique profile.",
            connect_agent_title: "Choose your AI co-pilot",
            connect_agent_subtitle: "Select an agent to analyze your profile and build your progression plan.",
            profile_title_empty: "OLM Profile",
            profile_title_user: "John Doe's OLM Profile",
            connected_to: "Connected to",
            objective_widget_title: "Current Objective",
            radar_placeholder: "Connect an agent to visualize the profile.",
            console_title: "Activity Console",
            console_placeholder: "Awaiting connection...",
            reset_btn: "Reset",
            analyze_with: "Analyze with {provider}",
            ai_insight_title: "Agent's Summary",
            challenges_title: "Your Next Challenges",
            challenges_by: "— by {provider}",
            challenges_placeholder: "Connect an agent to discover your personalized challenges.",
            reco_notice_success: "✅ Path successfully generated. The progression below simulates your potential gain.",
            progress_title: "Progress Tracking",
            progress_placeholder: "Your skill development will appear here.",
            certifications_title: "Certification Passports",
            certifications_placeholder: "Connect an agent to identify certifications aligned with your profile.",
            what_is_olm_title: "🧠 What is an OLM?",
            what_is_olm_p: "The <strong>Open Learner Model</strong> is your dynamic and portable skills profile. You own it, you control it, and it works everywhere.",
            why_mcp_title: "🔗 The MCP Standard",
            why_mcp_p: "The <strong>Model Context Protocol (MCP)</strong> is the universal language that allows your OLM to communicate securely and standardly with any AI.",
            design_fiction_title: "💡 A Vision of the Future",
            design_fiction_p: "This demo illustrates a future where every learner owns and controls their learning data, paving the way for universal skill recognition.",
            modal_title: "Authorize Connection",
            modal_subtitle: "Share your OLM data and set an objective for the analysis.",
            modal_data_title: "Data to Share",
            modal_objective_title: "Objective",
            modal_objective_select_sr: "Select an objective",
            modal_objective_p: "The agent will tailor its recommendations to this objective.",
            modal_add_context_btn: "+ Add objective",
            modal_cancel_btn: "Cancel",
            modal_authorize_btn: "Authorize & Launch",
            footer: "An interactive demo by Arnaud Guiovanna • 2025",
            log_connecting: "Securely connecting to AI agent...",
            log_connection_request: "OLM ➜ Connection request to {provider}",
            log_handshake_ok: "MCP 1.0 Handshake: OK",
            log_consent: "Consent ➜ Shared data: {granted}",
            log_objective: "🎯 Objective sent: Upskill for \"{context}\".",
            log_analysis: "OLM Analysis ➜ {count} potential optimizations identified.",
            log_skill_gain: "✔ Skill gain: {skill} (+{delta}) | source: {why}",
            log_recos_generated: "✔ Recommendations generated, ready to be explored.",
            log_challenge_complete: "✔ Challenge completed: \"{title}\" (+{delta} {skill})",
            log_new_skill: "✨ New skill added to profile: \"{skill}\"",
            reco_card_skill: "Skill",
            reco_card_duration: "Duration",
            reco_card_completed: "Completed",
            reco_card_potential_gain: "+{delta} pts",
            reco_card_take_challenge: "Take challenge",
            progress_bar_gain_text: "{initial} ➜ {final} (+{gain})",
            add_context_prompt: "Enter the name for your new objective:",
            reco_notice_update: "✅ Skill \"{skill}\" updated in your profile.",
            cert_modal_title: "Certification: {title}",
            cert_modal_subtitle: "Proposed by your agent {agent}",
            cert_modal_recognized: "Recognized by the Ministry of Labour",
            cert_modal_add_btn: "Add to my agent",
            cert_modal_syllabus_btn: "View syllabus",
            cert_modal_syllabus_btn_hide: "Hide syllabus",
            cert_modal_syllabus_title: "Certification Syllabus",
            cert_added_notice: "✅ The certification path has been added to your {agent} agent."
        }
    };

    const initialSkills = [
      { competency: { fr: "Lecture de plans", en: "Blueprint Reading" }, level: 70 },
      { competency: { fr: "Installation sanitaire", en: "Sanitary Installation" }, level: 85 },
      { competency: { fr: "Soudure cuivre", en: "Copper Welding" }, level: 65 },
      { competency: { fr: "Maintenance chaudières", en: "Boiler Maintenance" }, level: 78 },
      { competency: { fr: "Réseaux de chauffage", en: "Heating Networks" }, level: 60 },
      { competency: { fr: "Relation client", en: "Customer Relations" }, level: 55 }
    ];

    const PROVIDERS = {
      ChatGPT: { deltas: [{ skill: "Relation client", delta: 10, why: "retour chantier: communication et empathie" }, { skill: "Réseaux de chauffage", delta: 5, why: "optimisation de circuits et équilibrage" }], recos: [{ title: {fr: "Efficacité énergétique", en: "Energy Efficiency"}, skill: "Réseaux de chauffage", delta: 4, duration: "2h", rationale: {fr: "paramétrage circuits radiateurs", en: "radiator circuit configuration"} }, { title: {fr: "Diagnostic chaudière", en: "Boiler Diagnostics"}, skill: "Maintenance chaudières", delta: 5, duration: "1h30", rationale: {fr: "lecture télémétrie", en: "telemetry reading"} }, { title: {fr: "Situations client difficiles", en: "Difficult Customer Situations"}, skill: "Relation client", delta: 6, duration: "45min", rationale: {fr: "gestion d'objections", en: "objection handling"} }], insight: {fr: "Bonjour John. Votre profil montre une excellente maîtrise de l'installation. Pour atteindre votre objectif, je suggère de renforcer la 'Relation client' et d'explorer les nouvelles normes en efficacité énergétique.", en: "Hello John. Your profile shows excellent installation mastery. To reach your goal, I suggest strengthening 'Customer Relations' and exploring new energy efficiency standards."} },
      Gemini: { deltas: [{ skill: "Soudure cuivre", delta: 7, why: "brasage avancé: contrôle capillarité" }, { skill: "Maintenance chaudières", delta: 5, why: "préventif selon historique pannes" }], recos: [{ title: {fr: "Brasage cuivre avancé", en: "Advanced Copper Brazing"}, skill: "Soudure cuivre", delta: 7, duration: "1h", rationale: {fr: "qualité & sécurité", en: "quality & safety"} }, { title: {fr: "Maintenance préventive", en: "Preventive Maintenance"}, skill: "Maintenance chaudières", delta: 5, duration: "1h", rationale: {fr: "checklist capteurs", en: "sensor checklist"} }, { title: {fr: "Checklist fin de chantier", en: "End-of-job Checklist"}, skill: "Relation client", delta: 3, duration: "20min", rationale: {fr: "satisfaction client", en: "customer satisfaction"} }], insight: {fr: "Analyse terminée. Vos compétences techniques en 'Soudure' et 'Maintenance' sont solides. L'objectif 'Chantier en industrie' requiert une excellence dans ces domaines. Je vous propose des défis pour formaliser ces savoir-faire.", en: "Analysis complete. Your technical skills in 'Welding' and 'Maintenance' are solid. The 'Industrial Site Work' objective requires excellence in these areas. I am proposing challenges to formalize this expertise."} },
      Claude: { deltas: [{ skill: "Lecture de plans", delta: 6, why: "schémas isométriques et repérage" }, { skill: "Relation client", delta: 4, why: "script de communication claire" }], recos: [{ title: {fr: "Communication proactive", en: "Proactive Communication"}, skill: "Relation client", delta: 7, duration: "30min", rationale: {fr: "anticiper les questions", en: "anticipating questions"} }, { title: {fr: "Schémas isométriques", en: "Isometric Schematics"}, skill: "Lecture de plans", delta: 5, duration: "45min", rationale: {fr: "repères & cotes", en: "markers & dimensions"} }, { title: {fr: "Sécurité gaz", en: "Gas Safety"}, skill: "Installation sanitaire", delta: 2, duration: "25min", rationale: {fr: "bonnes pratiques", en: "best practices"} }], insight: {fr: "John, votre profil est équilibré. Pour un entretien, la clarté de la communication est aussi importante que la technique. Mes recommandations visent à renforcer votre capacité à expliquer des concepts techniques et à mieux interagir.", en: "John, your profile is well-balanced. For an interview, clear communication is as important as technical skill. My recommendations aim to enhance your ability to explain technical concepts and to better interact with recruiters."} },
      Mistral: { deltas: [{ skill: "Réseaux de chauffage", delta: 6, why: "optimisation européenne (normes)" }, { skill: "Installation sanitaire", delta: 4, why: "conformité DTU" }], recos: [{ title: {fr: "Normes européennes", en: "European Standards"}, skill: "Installation sanitaire", delta: 4, duration: "1h", rationale: {fr: "sécurité & conformité", en: "safety & compliance"} }, { title: {fr: "Équilibrage réseau terrain", en: "On-site Network Balancing"}, skill: "Réseaux de chauffage", delta: 6, duration: "1h15", rationale: {fr: "mesures & ajustements", en: "measurements & adjustments"} }, { title: {fr: "Communication chantier", en: "Site Communication"}, skill: "Relation client", delta: 4, duration: "30min", rationale: {fr: "clarté & trace", en: "clarity & traceability"} }], insight: {fr: "Votre expertise terrain est évidente. Pour vous démarquer, une maîtrise des normes européennes (DTU) est un atout considérable. Les défis que je propose vous permettront de valider ces connaissances spécifiques.", en: "Your field expertise is clear. To stand out, mastering European standards (DTU) is a significant advantage. The challenges I'm offering will allow you to validate this specific knowledge."} },
      Llama: { deltas: [{ skill: "Relation client", delta: 5, why: "script conversationnel clair" }, { skill: "Lecture de plans", delta: 5, why: "repérage symboles" }], recos: [{ title: {fr: "Lecture de plans pratique", en: "Practical Blueprint Reading"}, skill: "Lecture de plans", delta: 5, duration: "45min", rationale: {fr: "exercices guidés", en: "guided exercises"} }, { title: {fr: "Bases des réseaux intelligents", en: "Smart Grid Basics"}, skill: "Domotique CVC", delta: 8, duration: "40min", rationale: {fr: "repères domotique", en: "home automation basics"} }, { title: {fr: "Maintenance avec l'IA", en: "AI-Assisted Maintenance"}, skill: "Maintenance chaudières", delta: 4, duration: "45min", rationale: {fr: "aide au diagnostic", en: "diagnostic assistance"} }], insight: {fr: "Votre profil est solide. Je remarque un potentiel de développement vers les technologies émergentes. J'ai donc inclus un défi sur la 'Domotique CVC', une nouvelle compétence qui pourrait fortement valoriser votre profil.", en: "Your profile is solid. I see potential for growth into emerging technologies. I have therefore included a challenge on 'HVAC Domotics', a new skill that could greatly enhance your profile."} }
    }
    
    let CONTEXTS = [
      { id: "recrutement", label: { fr: "Préparer un entretien", en: "Prepare for an interview" } },
      { id: "industrie", label: { fr: "Intervenir en industrie", en: "Work on an industrial site" } },
      { id: "gestion_projet", label: { fr: "Gérer un projet CVC", en: "Manage an HVAC project" } }
    ];

    const CERTIFICATIONS = [
      { id: "cert-openai-1", org: "ChatGPT", emoji: "🤖", title: {fr:"Diagnostic énergétique assisté par IA", en:"AI-Assisted Energy Diagnostics"}, color:"emerald", rationale: {fr:"Recommandé pour votre maîtrise de la maintenance et votre intérêt pour les nouvelles technologies.", en:"Recommended for your maintenance skills and interest in new technologies."}, syllabus: { fr: ["Module 1: Audit thermique", "Module 2: Analyse des données de consommation", "Module 3: Recommandations et ROI"], en: ["Module 1: Thermal Audit", "Module 2: Consumption Data Analysis", "Module 3: Recommendations & ROI"] } },
      { id: "cert-google-1", org: "Gemini", emoji: "✨", title: {fr:"Réseaux thermiques intelligents", en:"Smart Thermal Networks"}, color:"blue", rationale: {fr:"Votre expertise en réseaux de chauffage est le prérequis idéal pour cette certification avancée.", en:"Your heating network expertise is the ideal prerequisite for this advanced certification."}, syllabus: { fr: ["Module 1: Capteurs et IoT", "Module 2: Algorithmes d'optimisation", "Module 3: Maintenance prédictive"], en: ["Module 1: Sensors & IoT", "Module 2: Optimization Algorithms", "Module 3: Predictive Maintenance"] } },
      { id: "cert-anthropic-1", org: "Claude", emoji: "🧭", title: {fr:"Maintenance éthique et durable", en:"Ethical & Sustainable Maintenance"}, color:"amber", rationale: {fr:"Validez votre approche centrée sur le client et la durabilité, des compétences de plus en plus recherchées.", en:"Validate your customer-centric and sustainability-focused approach, skills that are increasingly in demand."}, syllabus: { fr: ["Module 1: Principes de durabilité", "Module 2: Communication transparente", "Module 3: Fin de vie des équipements"], en: ["Module 1: Sustainability Principles", "Module 2: Transparent Communication", "Module 3: Equipment End-of-Life"] } },
      { id: "cert-mistral-1", org: "Mistral", emoji: "🇪🇺", title: {fr:"Expert Normes Européennes CVC", en:"HVAC European Standards Expert"}, color:"slate", rationale: {fr:"Transformez votre connaissance des normes en un atout certifié et reconnu sur le marché européen.", en:"Turn your knowledge of standards into a certified and recognized asset on the European market."}, syllabus: { fr: ["Module 1: Normes EN 378 & ISO 50001", "Module 2: Application sur site", "Module 3: Veille réglementaire"], en: ["Module 1: EN 378 & ISO 50001 Standards", "Module 2: On-site Application", "Module 3: Regulatory Watch"] } },
      { id: "cert-meta-1", org: "Llama", emoji: "🧠", title: {fr:"Technicien CVC en environnement connecté", en:"HVAC Technician in Connected Environments"}, color:"fuchsia", rationale: {fr:"Faites le pont entre votre métier et le monde de la domotique et de l'IoT.", en:"Bridge the gap between your profession and the world of home automation and IoT."}, syllabus: { fr: ["Module 1: Introduction à la domotique", "Module 2: Protocoles (Zigbee, Matter)", "Module 3: Sécurité des réseaux domestiques"], en: ["Module 1: Introduction to Domotics", "Module 2: Protocols (Zigbee, Matter)", "Module 3: Home Network Security"] } }
    ];

    let state = { skills: [], provider: null, logs: [], recos: [], consents: { competences:true, chantiers:true, notes:false, disponibilites:false, objectifs:true }, context: CONTEXTS[0].id, pendingProvider: null, initialSkillsSnapshot: [], lastFocused: null, language: 'fr' };
    let modalKeyListener = null;
    let certModalKeyListener = null;
    
    const $ = (s) => document.querySelector(s);
    const el = (tag, cls) => { const e=document.createElement(tag); if(cls) e.className=cls; return e; };
    
    function T(key, replacements = {}) {
        let text = translations[state.language][key] || key;
        for (const [placeholder, value] of Object.entries(replacements)) {
            text = text.replace(`{${placeholder}}`, value);
        }
        return text;
    }

    const log = (key, replacements = {}) => { 
        state.logs.push({key, replacements}); 
        renderConsole(); 
    };
    
    function getProviderLogoHtml(name) {
      const commonClasses = "h-8 w-8 object-contain";
      const logos = {
          ChatGPT: "https://registry.npmmirror.com/@lobehub/icons-static-png/latest/files/light/openai.png",
          Gemini: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Google_Gemini_logo.svg/1280px-Google_Gemini_logo.svg.png",
          Claude: "https://cdn.worldvectorlogo.com/logos/anthropic-1.svg", 
          Mistral: "https://registry.npmmirror.com/@lobehub/icons-static-png/latest/files/dark/mistral-color.png",
          Llama: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/05/Meta_Platforms_Inc._logo_%28cropped%29.svg/2560px-Meta_Platforms_Inc._logo_%28cropped%29.svg.png"
      };
      const url = logos[name] || '';
      return `<img src="${url}" alt="Logo for ${name}" class="${commonClasses}">`;
    }

    const LLM_LIST = ["ChatGPT","Gemini","Claude","Mistral","Llama"];

    function renderLLMButtons(){
      const host = $("#llmButtons"); host.innerHTML = "";
      LLM_LIST.forEach((name) => {
        const btn = el("button", `w-full h-24 px-3 rounded-2xl flex flex-col items-center justify-center gap-2 text-slate-700 font-semibold text-sm bg-white hover:bg-slate-50 border border-slate-200 shadow-sm hover:shadow-md transition-all active:scale-[0.98] focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500`);
        btn.setAttribute("type","button");
        btn.setAttribute("aria-label", T('analyze_with', {provider: name}));
        btn.addEventListener("click", ()=>openConsent(name));
        const iconWrap = el('div', 'h-10 flex items-center justify-center');
        iconWrap.innerHTML = getProviderLogoHtml(name);
        const label = el('span');
        label.textContent = name;
        btn.append(iconWrap, label);
        host.appendChild(btn);
      });
    }
    
    function renderRadar(){
        const host = $("#radar"); host.innerHTML = "";
        if(!state.skills.length){
            host.innerHTML = `<p class="text-sm text-slate-500">${T('radar_placeholder')}</p>`;
            host.className='w-full h-72 flex items-center justify-center';
            return;
        }
        host.className = 'w-full h-72';
        const R=90, cx=140, cy=140, n=state.skills.length;
        const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
        svg.setAttribute("viewBox",`0 0 ${cx*2} ${cy*2}`); svg.setAttribute("class","w-full h-full");
        svg.setAttribute("role","img");
        svg.innerHTML = `<title>Radar des compétences</title><desc>Visualisation des niveaux des compétences pour John Doe</desc>`;

        [25,50,75,100].forEach(val => {
            const r = (val/100) * R;
            const c=document.createElementNS(svg.namespaceURI,"circle");
            c.setAttribute("cx",cx); c.setAttribute("cy",cy); c.setAttribute("r",r);
            c.setAttribute("fill", "none");
            c.setAttribute("class","stroke-slate-200/70");
            svg.appendChild(c);
        });
        for(let i=0;i<n;i++){
            const a= (Math.PI*2*i)/n - Math.PI/2;
            const l=document.createElementNS(svg.namespaceURI,"line");
            l.setAttribute("x1",cx); l.setAttribute("y1",cy);
            l.setAttribute("x2",cx+R*Math.cos(a)); l.setAttribute("y2",cy+R*Math.sin(a));
            l.setAttribute("class","stroke-slate-200/70");
            svg.appendChild(l);
        }
        const pts = state.skills.map((s,i)=>{ const a=(Math.PI*2*i)/n - Math.PI/2; const r=(s.level/100)*R; return `${cx+r*Math.cos(a)},${cy+r*Math.sin(a)}`; }).join(" ");
        const poly = document.createElementNS(svg.namespaceURI,"polygon");
        poly.setAttribute("points", pts);
        poly.setAttribute("class","fill-blue-500/20 stroke-blue-600");
        poly.style.transition = "points 0.5s ease-in-out";
        svg.appendChild(poly);

        state.skills.forEach((s,i)=>{
            const a=(Math.PI*2*i)/n - Math.PI/2;
            const tx=cx+(R+22)*Math.cos(a); const ty=cy+(R+22)*Math.sin(a);
            const t=document.createElementNS(svg.namespaceURI,"text");
            t.setAttribute("x",tx); t.setAttribute("y",ty);
            t.setAttribute("text-anchor","middle"); t.setAttribute("dominant-baseline","middle");
            t.setAttribute("class","text-xs font-medium fill-slate-600");
            t.textContent=s.competency[state.language]; svg.appendChild(t);
        });
        host.appendChild(svg);
    }

    function renderProviderBadge(){
      const badge = $("#providerBadge");
      const objectiveWidget = $("#objectiveWidget");
      if(state.provider){
        badge.innerHTML = `${getProviderLogoHtml(state.provider)} <span class="ml-2">${T('connected_to')} <strong>${state.provider}</strong></span>`;
        badge.classList.remove("hidden");
        badge.classList.add("inline-flex");
        objectiveWidget.classList.remove('hidden');
        $('#objectiveText').textContent = CONTEXTS.find(c => c.id === state.context)?.label[state.language] || '';
        $('#profileTitle').textContent= T('profile_title_user');
      } else {
        badge.classList.add("hidden");
        badge.classList.remove("inline-flex");
        objectiveWidget.classList.add('hidden');
        $('#profileTitle').textContent= T('profile_title_empty');
      }
    }
    
    function renderConsole(){
        const c = $("#console");
        if (state.logs.length === 0) {
            c.innerHTML = `<span class="text-slate-500">${T('console_placeholder')}</span>`;
            return;
        }
        c.innerHTML = state.logs.map(l => {
            let msg = T(l.key, l.replacements)
                         .replace(/✔/g, '<span class="text-green-400">✔</span>')
                         .replace(/⚙️/g, '<span class="text-yellow-400">⚙️</span>')
                         .replace(/➜/g, '<span class="text-sky-400">➜</span>')
                         .replace(/🎯/g, '<span class="text-violet-400">🎯</span>');
            return `<div class="fade-in">${msg}</div>`;
        }).join("");
        c.scrollTop = c.scrollHeight;
    }
    
    function renderRecos(){
      const hint = $("#recoHint"), prov = $("#recoProvider"), grid = $("#recoGrid"), skeletons = $("#recoSkeletons");
      grid.innerHTML = "";
      if(!state.provider){
        hint.classList.remove("hidden"); prov.textContent="";
        skeletons.classList.add("hidden");
        return;
      }
      hint.classList.add("hidden"); prov.textContent = T('challenges_by', {provider: state.provider});
      
      const allRecos = state.recos;

      allRecos.forEach((r, idx) => {
        const cardClasses = {
            idle: "card",
            pending: "border-amber-300 bg-amber-50/50",
            completed: "border-green-300 bg-green-50/50 opacity-70"
        }[r.status];
        
        const card = el("div",`p-5 flex flex-col transition-all duration-300 fade-in ${cardClasses}`);
        card.style.animationDelay = `${idx * 100}ms`;
        
        let buttonHtml = '';
        if (r.status === 'idle') {
            buttonHtml = `<button class="w-full px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold transition-colors" data-reco-id="${r.id}">${T('reco_card_take_challenge')}</button>`;
        } else if (r.status === 'pending') {
            buttonHtml = `<div class="w-full text-center"><p class="text-xs font-semibold text-amber-800">Parcours généré...</p></div>`;
        } else { // completed
            buttonHtml = `<div class="w-full px-3 py-2 rounded-lg bg-green-600 text-white text-sm font-semibold text-center flex items-center justify-center gap-2"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-11"/></svg>${T('reco_card_completed')}</div>`;
        }
        
        const skillName = (initialSkills.find(s => s.competency.fr === r.skill) || {competency: {}}).competency[state.language] || r.skill;

        card.innerHTML = `
          <div class="flex-1">
            <div class="flex items-start justify-between">
              <h3 class='text-base font-semibold text-slate-900'>${r.title[state.language]}</h3>
              <span class="text-sm font-bold text-green-600 whitespace-nowrap ml-2">${T('reco_card_potential_gain', {delta: r.delta})}</span>
            </div>
            <p class='mt-2 text-xs text-slate-500'>${r.rationale[state.language]}</p>
          </div>
          <div class="mt-4 pt-4 border-t border-slate-200/60 flex items-center justify-between text-xs text-slate-500">
            <span>${T('reco_card_skill')}: <strong>${skillName}</strong></span>
            <span>${T('reco_card_duration')}: <strong>${r.duration}</strong></span>
          </div>
          <div class="mt-4">${buttonHtml}</div>
        `;
        grid.appendChild(card);
      });
      
      grid.querySelectorAll('[data-reco-id]').forEach(button => {
          button.addEventListener('click', () => applyReco(button.dataset.recoId));
      });
    }

    function renderSkillProgress() {
        const host = $("#skillProgress");
        const hint = $("#gainsHint");
        host.innerHTML = "";
        
        if (!state.provider) {
            hint.classList.remove('hidden');
            return;
        }
        hint.classList.add('hidden');
        
        state.skills.forEach((skill, idx) => {
            const initialLevel = state.initialSkillsSnapshot.find(s => s.competency.fr === skill.competency.fr)?.level || 0;
            const currentLevel = skill.level;
            const achievedGain = currentLevel - initialLevel;
            
            const progressElement = el("div", "fade-in");
            progressElement.style.animationDelay = `${idx * 100}ms`;
            
            progressElement.innerHTML = `
                <div class="flex justify-between items-center mb-1.5">
                    <span class="text-sm font-medium text-slate-700">${skill.competency[state.language]}</span>
                    <span class="text-sm font-bold text-slate-800">${T('progress_bar_gain_text', {initial: initialLevel, final: currentLevel, gain: achievedGain})}</span>
                </div>
                <div class="h-2.5 w-full rounded-full progress-bar-bg overflow-hidden flex">
                    <div class="progress-bar-fg h-full" style="width: ${initialLevel}%"></div>
                    <div class="progress-bar-gain h-full" style="width: ${achievedGain}%"></div>
                </div>
            `;
            host.appendChild(progressElement);
        });
    }

    function renderAiInsight() {
        const section = $('#aiInsightSection');
        if (state.provider) {
            $('#aiInsightText').textContent = PROVIDERS[state.provider].insight[state.language] || "No summary available.";
            section.classList.remove('hidden');
            section.classList.add('fade-in');
        } else {
            section.classList.add('hidden');
        }
    }
    
    function renderCertifications() {
        const grid = $("#certGrid");
        const hint = $("#certHint");
        grid.innerHTML = "";
        if (!state.provider) {
            hint.classList.remove('hidden');
            return;
        }
        hint.classList.add('hidden');
        
        const providerOrgMap = { 'ChatGPT': 'ChatGPT', 'Gemini': 'Gemini', 'Claude': 'Claude', 'Mistral': 'Mistral', 'Llama': 'Llama' };
        const org = providerOrgMap[state.provider];
        const filteredCerts = CERTIFICATIONS.filter(c => c.org === org);

        filteredCerts.forEach((c, idx) => {
            const card = el('div',`card p-5 flex flex-col cursor-pointer`);
            card.dataset.certId = c.id;
            card.style.animationDelay = `${idx * 100}ms`;
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="text-3xl">${c.emoji}</span>
                    <div>
                        <h4 class="font-semibold text-slate-900">${c.title[state.language]}</h4>
                        <p class="text-xs text-slate-600">Organisme : ${c.org}</p>
                    </div>
                </div>
                <p class="mt-3 text-sm text-slate-700/90 flex-1">${c.rationale[state.language]}</p>
                <div class="mt-4">
                    <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-blue-100 text-blue-800">Passeport disponible</span>
                </div>
            `;
            grid.appendChild(card);
        });

        grid.addEventListener('click', (e) => {
            const card = e.target.closest('[data-cert-id]');
            if (card) {
                openCertModal(card.dataset.certId);
            }
        });
    }
    
    function getFocusable(container){ return container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'); }

    function renderContextOptions() {
      const sel = $("#contextSelect");
      sel.innerHTML = "";
      CONTEXTS.forEach(c => {
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.label[state.language];
        sel.appendChild(o);
      });
      sel.value = state.context;
    }

    function openConsent(name){
      state.pendingProvider = name; state.lastFocused = document.activeElement;
      $('#modalTitle').innerHTML = `${T('modal_title')} <span class="flex items-center gap-2 font-semibold">${getProviderLogoHtml(name)} ${name}</span>`;

      const cons = $("#consents"); cons.innerHTML = "";
      const options = [{ key:"competences", label:"Compétences actuelles" }, { key:"chantiers", label:"Historique de recherches" }, { key:"notes", label:"Notes personnelles" }, { key:"disponibilites", label:"Disponibilités" }, { key:"objectifs", label:"Objectifs professionnels" }];
      options.forEach(opt => {
        const id = `consent_${opt.key}`;
        const row = el("div","flex items-center gap-3");
        row.innerHTML = `<input type="checkbox" id="${id}" ${state.consents[opt.key] ? 'checked' : ''} class="h-4 w-4 rounded border-slate-400 text-blue-600 focus:ring-blue-500">
                         <label for="${id}" class="text-slate-800">${opt.label}</label>`;
        row.querySelector('input').addEventListener('change', e=> state.consents[opt.key] = e.target.checked);
        cons.appendChild(row);
      });
      
      renderContextOptions();
      $("#contextSelect").onchange = e => state.context = e.target.value;

      $("#addContextBtn").onclick = () => {
        const newContextLabel = prompt(T('add_context_prompt'));
        if (newContextLabel && newContextLabel.trim() !== "") {
          const newContextId = `custom_${Date.now()}`;
          CONTEXTS.push({ id: newContextId, label: {fr: newContextLabel.trim(), en: newContextLabel.trim()} });
          state.context = newContextId;
          renderContextOptions();
        }
      };

      const m = $("#modal"); m.classList.remove('hidden'); m.classList.add('flex');
      const focusables = getFocusable(m), first = focusables[0], last = focusables[focusables.length-1];
      first?.focus();
      
      modalKeyListener = (e) => {
          if(e.key === 'Tab'){
              if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
              else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
          } else if(e.key === 'Escape') closeModal();
      };
      m.addEventListener('keydown', modalKeyListener);

      m.querySelectorAll('[data-close]').forEach(b=> b.onclick = closeModal);
      $("#authorizeBtn").onclick = ()=>{ closeModal(); connectTo(state.pendingProvider); };
    }

    function closeModal(){
      const m=$("#modal");
      m.classList.add('hidden'); m.classList.remove('flex');
      if (modalKeyListener) {
        m.removeEventListener('keydown', modalKeyListener);
        modalKeyListener = null;
      }
      state.lastFocused?.focus();
    }

    function openCertModal(certId) {
        const cert = CERTIFICATIONS.find(c => c.id === certId);
        if (!cert) return;
        
        state.lastFocused = document.activeElement;
        const m = $("#certModal");
        
        $('#certModalTitle').textContent = T('cert_modal_title', { title: cert.title[state.language] });
        $('#certModalSubtitle').textContent = T('cert_modal_subtitle', { agent: state.provider });
        $('#certModalRationale').textContent = cert.rationale[state.language];

        const syllabusContainer = $('#certSyllabusContainer');
        const syllabusList = $('#certSyllabusList');
        const viewSyllabusBtn = $('#viewSyllabusBtn');
        const addCertBtn = $('#addCertToAgentBtn');
        
        syllabusContainer.classList.add('hidden');
        syllabusList.innerHTML = cert.syllabus[state.language].map(item => `<li>${item}</li>`).join('');
        viewSyllabusBtn.textContent = T('cert_modal_syllabus_btn');
        addCertBtn.textContent = T('cert_modal_add_btn');

        viewSyllabusBtn.onclick = () => {
            const isHidden = syllabusContainer.classList.toggle('hidden');
            viewSyllabusBtn.textContent = isHidden ? T('cert_modal_syllabus_btn') : T('cert_modal_syllabus_btn_hide');
        };

        addCertBtn.onclick = () => {
            const notice = $('#recoNotice');
            notice.textContent = T('cert_added_notice', {agent: state.provider});
            notice.classList.remove('hidden');
            setTimeout(() => notice.classList.add('hidden'), 5000);
            closeCertModal();
        };

        m.classList.remove('hidden'); m.classList.add('flex');
        const focusables = getFocusable(m), first = focusables[0], last = focusables[focusables.length - 1];
        first?.focus();

        certModalKeyListener = (e) => {
            if (e.key === 'Escape') closeCertModal();
            if (e.key === 'Tab') {
                if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); } 
                else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
            }
        };
        m.addEventListener('keydown', certModalKeyListener);
        m.querySelectorAll('[data-cert-close]').forEach(b => b.onclick = closeCertModal);
    }

    function closeCertModal() {
        const m = $("#certModal");
        m.classList.add('hidden'); m.classList.remove('flex');
        if (certModalKeyListener) {
            m.removeEventListener('keydown', certModalKeyListener);
            certModalKeyListener = null;
        }
        state.lastFocused?.focus();
    }
    
    async function connectTo(name){
      state.provider = name; 
      state.logs = []; 
      state.recos = [];
      state.skills = JSON.parse(JSON.stringify(initialSkills));
      state.initialSkillsSnapshot = JSON.parse(JSON.stringify(initialSkills));

      $("#recoSkeletons").classList.remove("hidden");
      $("#recoGrid").innerHTML = ''; 
      $("#certGrid").innerHTML = '';
      $('#aiInsightSection').classList.add('hidden');

      log("log_connecting");
      log("log_connection_request", {provider: name});
      await new Promise(r=>setTimeout(r,300));
      log("log_handshake_ok");
      const granted = Object.entries(state.consents).filter(([,v])=>v).map(([k])=>k).join(", ") || "(aucune)";
      log("log_consent", {granted});
      await new Promise(r=>setTimeout(r,400));
      
      const context = CONTEXTS.find(c => c.id === state.context);
      if (context) {
        log("log_objective", {context: context.label[state.language]});
      }
      await new Promise(r=>setTimeout(r,500));
      
      const conf = PROVIDERS[name];
      log("log_analysis", {count: conf.deltas.length});
      conf.deltas.forEach(d=>{
          const skillToUpdate = state.skills.find(s => s.competency.fr === d.skill);
          if(skillToUpdate) skillToUpdate.level = Math.min(100, skillToUpdate.level + d.delta);
          log("log_skill_gain", {skill: d.skill, delta: d.delta, why: d.why});
      });
      await new Promise(r=>setTimeout(r,500));
      log("log_recos_generated");
      state.recos = conf.recos.map((r,i)=> ({ id: `${name}-${i}`, status: 'idle', ...r }));

      $("#recoSkeletons").classList.add("hidden");
      renderAll();
    }

    function applyReco(id) {
        const rec = state.recos.find(r => r.id === id);
        if (!rec || rec.status !== 'idle') return;
        
        rec.status = 'pending';
        
        const notice = $('#recoNotice');
        notice.textContent = T('reco_notice_success', {provider: state.provider});
        notice.classList.remove('hidden');
        setTimeout(() => notice.classList.add('hidden'), 5000);

        renderAll();

        setTimeout(() => {
            completeReco(id);
        }, 2500);
    }

    function completeReco(id) {
        const rec = state.recos.find(r => r.id === id);
        if (!rec || rec.status !== 'pending') return;
        
        let skillToUpdate = state.skills.find(s => s.competency.fr === rec.skill);

        if (skillToUpdate) {
            skillToUpdate.level = Math.min(100, skillToUpdate.level + rec.delta);
        } else {
            const newSkillName = {fr: rec.skill, en: rec.skill};
            const newSkill = { competency: newSkillName, level: rec.delta };
            state.skills.push(newSkill);
            state.initialSkillsSnapshot.push({ competency: newSkillName, level: 0 });
            log("log_new_skill", {skill: rec.skill});
        }
        
        rec.status = 'completed';
        log("log_challenge_complete", {title: rec.title[state.language], delta: rec.delta, skill: rec.skill});
        renderAll();
    }
    
    function updateUI(lang) {
        if (!['fr', 'en'].includes(lang)) return;
        state.language = lang;
        document.documentElement.lang = lang;

        document.querySelectorAll('[data-translate-key]').forEach(el => {
            el.innerHTML = T(el.dataset.translateKey);
        });

        document.getElementById('lang-fr').classList.toggle('active', lang === 'fr');
        document.getElementById('lang-en').classList.toggle('active', lang === 'en');
        
        renderAll();
    }

    function reset(){ 
      state.skills = [];
      state.provider = null;
      state.logs = [];
      state.recos = [];
      state.initialSkillsSnapshot = [];
      $('#recoNotice').classList.add('hidden');
      renderAll();
    }
    
    function renderAll(){
      renderLLMButtons();
      renderRadar();
      renderProviderBadge();
      renderConsole();
      renderRecos();
      renderSkillProgress();
      renderAiInsight();
      renderCertifications();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        $('#resetBtn').addEventListener('click', reset);
        $('#lang-fr').addEventListener('click', () => updateUI('fr'));
        $('#lang-en').addEventListener('click', () => updateUI('en'));

        updateUI(state.language);
    });
  </script>
</body>
</html>